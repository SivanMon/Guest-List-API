<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Guest List • Live Dashboard</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg:#0b1220; --bg-2:#0e1630; --card:#111a35; --text:#e8ecf6; --muted:#98a3c7;
    --brand:#7aa2ff; --brand-2:#56e1b6; --danger:#ff6677; --ok:#47d597; --warn:#f5c84b;
    --ring:0 12px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.08) inset;
    --r:18px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8fe; --bg-2:#eef2ff; --card:#ffffff; --text:#101423; --muted:#51607a;
      --brand:#3858ff; --brand-2:#10b981; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --ring:0 10px 30px rgba(0,0,0,.08), 0 0 0 1px rgba(0,0,0,.06) inset;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:
      radial-gradient(900px 700px at 110% -10%, rgba(100,140,255,.25), transparent 60%),
      radial-gradient(800px 600px at -10% 110%, rgba(80,220,180,.20), transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{width:min(1100px,100%); display:grid; gap:18px}
  header{
    display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logo{
    width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
    color:white;font-weight:900;letter-spacing:.4px;
    background:conic-gradient(from 0deg at 50% 50%,var(--brand),var(--brand-2),var(--brand));
    box-shadow:0 12px 30px rgba(0,0,0,.25);
  }
  .title{font-weight:900; font-size:1.35rem}
  .subtitle{color:var(--muted); font-size:.95rem; margin-top:-2px}

  .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,0)) border-box;
    border:1px solid rgba(255,255,255,.14);
    border-radius:var(--r); padding:18px; box-shadow:var(--ring); backdrop-filter:blur(8px)
  }

  .btns{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;
    color:#fff;background:var(--brand);box-shadow:0 8px 24px rgba(56,88,255,.35);
    transition:transform .08s ease, filter .2s ease, opacity .2s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.ok{background:var(--brand-2); box-shadow:0 8px 24px rgba(16,185,129,.32)}
  .btn.warn{background:var(--warn); color:#1a1a1a}
  .btn.danger{background:var(--danger)}
  .ghost{background:transparent;color:var(--text);border:1px dashed rgba(255,255,255,.25)}

  .pill{padding:.25rem .6rem; border-radius:999px; font-size:.8rem; border:1px solid rgba(255,255,255,.25)}
  .pill.ok{background:rgba(71,213,151,.16); color:var(--ok); border-color:rgba(71,213,151,.35)}
  .pill.bad{background:rgba(255,102,119,.14); color:var(--danger); border-color:rgba(255,102,119,.35)}
  .pill.neutral{background:rgba(122,162,255,.12); color:var(--brand)}

  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:var(--muted)}
  .table{width:100%; border-collapse:collapse; margin-top:6px}
  .table th,.table td{padding:10px 12px; text-align:left; border-bottom:1px dashed rgba(255,255,255,.15)}
  .muted{color:var(--muted)}
  .kbd{display:inline-block;padding:.1rem .4rem;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.06)}

  /* floating gradient blob */
  .blob{
    position:absolute; inset:auto 0 -60px auto; width:210px; height:210px; border-radius:50%;
    filter:blur(24px); opacity:.55;
    background:radial-gradient(closest-side, var(--brand) 0%, transparent 70%),
               radial-gradient(closest-side, var(--brand-2) 0%, transparent 70%);
    animation:float 8s ease-in-out infinite alternate;
    pointer-events:none
  }
  @keyframes float{
    from{ transform:translate(40px,0) rotate(0deg) }
    to  { transform:translate(-10px,-20px) rotate(18deg) }
  }

  /* toasts */
  .toasts{position:fixed; right:16px; bottom:16px; display:grid; gap:10px; z-index:3}
  .toast{background:var(--card); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px 12px; box-shadow:var(--ring); transform:translateY(8px); opacity:0; animation:pop .25s ease forwards}
  @keyframes pop{to{transform:none; opacity:1}}

  /* shimmer skeleton */
  .skeleton{position:relative; overflow:hidden; background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06)); background-size:200% 100%; animation:shimmer 1s linear infinite}
  @keyframes shimmer{to{background-position:-200% 0}}

  .footer{color:var(--muted); text-align:center; font-size:.9rem}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">GL</div>
        <div>
          <div class="title">Guest List — Live Dashboard</div>
          <div class="subtitle">Instant health checks, live guests, and quick actions.</div>
        </div>
      </div>
      <div id="healthPill" class="pill neutral">health: unknown</div>
    </header>

    <div class="grid">
      <!-- Live Panel -->
      <section class="card">
        <div class="row">
          <h2 style="margin:0">Live</h2>
          <div class="mono" id="baseUrl"></div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button id="btnHealth" class="btn">Check Health</button>
          <button id="btnList" class="btn ok">Refresh Guests</button>
          <button id="btnAddSample" class="btn ghost">Add Sample</button>
          <button id="btnClear" class="btn danger" title="Requires DELETE /guests">Clear All</button>
        </div>

        <table class="table" id="tbl">
          <thead><tr><th>Name</th><th>Phone</th><th>Note</th><th>ID</th></tr></thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="muted skeleton">Loading live data…</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Quick Add -->
      <section class="card" style="position:relative">
        <div class="blob"></div>
        <h2 style="margin:0 0 8px">Quick Add</h2>
        <div style="display:grid; gap:10px">
          <input id="name"  placeholder="Full name (e.g., Ada Lovelace)" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--text);outline:none"/>
          <input id="phone" placeholder="+1 555 123 4567"       style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--text);outline:none"/>
          <input id="note"  placeholder="Table 4 / Vegetarian / VIP" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--text);outline:none"/>
          <div class="btns">
            <button id="btnAdd" class="btn ok">Add Guest</button>
            <button id="btnReset" class="btn ghost">Reset</button>
          </div>
          <div class="muted" style="font-size:.9rem">
            Tip: <span class="kbd">curl</span>
            <code class="mono">-X POST -H "Content-Type: application/json" -d '{"name":"Ada","phone":"+1555"}' <span id="curl"></span>/guests</code>
          </div>
        </div>
      </section>
    </div>

    <section class="card">
      <h2 style="margin:0 0 8px">Activity</h2>
      <div id="log" class="mono muted" style="max-height:160px; overflow:auto; white-space:pre-wrap"></div>
    </section>

    <p class="footer">Auto-refresh every 5s • No external dependencies • Light/Dark friendly</p>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const base = location.origin; // works for LB or localhost
  $("baseUrl").textContent = base;
  $("curl").textContent = base;

  const toast = (msg, kind="info")=>{
    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = msg;
    if(kind==="ok") t.style.borderColor="rgba(16,185,129,.35)";
    if(kind==="err") t.style.borderColor="rgba(239,68,68,.45)";
    $("toasts").appendChild(t);
    setTimeout(()=> t.remove(), 3500);
  };
  const log = (s)=>{ $("log").textContent = `[${new Date().toLocaleTimeString()}] ${s}\n` + $("log").textContent; };
  const setHealth = (ok, txt)=>{
    const pill = $("healthPill");
    pill.textContent = `health: ${txt}`;
    pill.className = "pill " + (ok ? "ok" : (txt==="unknown"?"neutral":"bad"));
  };
  const esc = (s)=> String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  // ---------- API ----------
  async function safeJSON(res){
    const ct = res.headers.get("content-type")||"";
    return ct.includes("json") ? res.json() : res.text();
  }

  async function checkHealth(btn){
    if(btn){ btn.disabled = true; btn.textContent = "Checking…"; }
    try{
      const res = await fetch(base + "/health", {cache:"no-store"});
      const body = await safeJSON(res);
      setHealth(res.ok, res.ok ? "healthy" : "unhealthy");
      log(`GET /health → ${res.status}`);
      if(!res.ok) toast("Service unhealthy", "err");
    }catch(e){
      setHealth(false, "unreachable");
      toast("Service unreachable", "err");
      log(`GET /health failed`);
    }finally{
      if(btn){ btn.disabled=false; btn.textContent="Check Health"; }
    }
  }

  async function listGuests(btn){
    if(btn){ btn.disabled = true; btn.textContent = "Refreshing…"; }
    try{
      const res = await fetch(base + "/guests", {cache:"no-store"});
      const data = await safeJSON(res);
      renderGuests(Array.isArray(data)?data:[]);
      log(`GET /guests → ${res.status}`);
    }catch(e){
      renderGuests([]);
      log(`GET /guests failed`);
    }finally{
      if(btn){ btn.disabled=false; btn.textContent="Refresh Guests"; }
    }
  }

  function renderGuests(arr){
    const tbody = $("tbody");
    if(!arr.length){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">No guests yet.</td></tr>`;
      return;
    }
    tbody.innerHTML = arr.map(g=>{
      const id = g.id || g.guestId || g.pk || "";
      const name = g.name || g.fullName || "—";
      const phone = g.phone || g.phoneNumber || "";
      const note = g.note || g.notes || "";
      return `<tr><td>${esc(name)}</td><td>${esc(phone)}</td><td>${esc(note)}</td><td class="muted mono">${esc(id)}</td></tr>`;
    }).join("");
  }

  async function addSample(){
    try{
      const res = await fetch(base + "/guests", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name:"Ada Lovelace", phone:"+1 555 123 4567", note:"VIP sample" })
      });
      if(res.ok){ toast("Sample guest added","ok"); listGuests(); }
      else{ toast("Add failed","err"); }
      log(`POST /guests (sample) → ${res.status}`);
    }catch(e){ toast("Request failed","err"); }
  }

  async function addGuest(){
    const name = $("name").value.trim();
    if(!name){ toast("Please enter a name","err"); return; }
    const body = {
      name,
      phone: $("phone").value.trim(),
      note: $("note").value.trim()
    };
    try{
      const res = await fetch(base + "/guests", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(res.ok){
        $("name").value=""; $("phone").value=""; $("note").value="";
        toast("Guest added","ok"); listGuests();
      }else{
        const t = await res.text();
        toast("Add failed: " + esc(t), "err");
      }
      log(`POST /guests → ${res.status}`);
    }catch(e){ toast("Request failed","err"); }
  }

  async function clearGuests(){
    if(!confirm("Clear ALL guests? This cannot be undone.")) return;
    try{
      const res = await fetch(base + "/guests", { method:"DELETE" });
      if(res.ok){ toast("All guests cleared","ok"); listGuests(); }
      else{ toast("Clear failed","err"); }
      log(`DELETE /guests → ${res.status}`);
    }catch(e){ toast("Request failed","err"); }
  }

  // ---------- wiring ----------
  $("btnHealth").onclick = () => checkHealth($("btnHealth"));
  $("btnList").onclick  = () => listGuests($("btnList"));
  $("btnAddSample").onclick = () => addSample();
  $("btnClear").onclick = () => clearGuests();
  $("btnAdd").onclick   = () => addGuest();
  $("btnReset").onclick = () => { $("name").value=""; $("phone").value=""; $("note").value=""; };

  // initial load
  checkHealth();
  listGuests();

  // auto-refresh guests every 5s
  setInterval(listGuests, 5000);
</script>
</body>
</html>
